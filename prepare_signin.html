<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <!-- Primary Meta Tags -->
  <title>Prepare Meeting | Herely</title>
  <meta name="title" content="Prepare Meeting | Herely" />
  <meta name="description" content="Prepare and schedule meetings for attendance tracking with Herely." />
  <meta name="keywords" content="meeting preparation, attendance tracking, schedule meeting, herely" />
  <meta name="author" content="Herely" />
  <meta name="robots" content="noindex, nofollow" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo_herely_hand_left_curve.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/logo_herely_hand_left_curve.png" />
  <link rel="apple-touch-icon" href="/assets/logo_herely_hand_left_curve.png" />
  
  <!-- Additional SEO -->
  <meta name="theme-color" content="#2C5282" />
  <meta name="msapplication-TileColor" content="#2C5282" />
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: { 
          colors: { 
            primary: '#2C5282',
            secondary: '#4A5568',
            accent: '#E53E3E',
            text: '#2D3748'
          },
          fontFamily: {
            'sans': ['Inter', 'Source Sans Pro', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      color: #2D3748;
    }
    .btn-primary {
      border-radius: 4px;
      box-shadow: none;
      border: 1px solid #2C5282;
    }
  </style>
</head>
<body class="bg-white text-gray-800">

<!-- =========  HEADER  ========= -->
<header id="header" class="bg-white mb-8 border-b border-gray-200 transition-all duration-300 sticky top-0 z-50">
  <div class="max-w-6xl mx-auto px-4 py-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <a href="/" class="text-3xl font-semibold text-primary">
      Herely
    </a>
    
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 w-full sm:w-auto">
      <button onclick="window.location.href='/admin.html'"
        class="px-4 py-2 bg-white text-primary border border-primary rounded-sm hover:bg-gray-50 transition-colors">
        Dashboard
      </button>
    </div>
  </div>
</header>

<!-- =========  SHIMMER PLACEHOLDER  ========= -->
<div id="shimmer" class="animate-pulse space-y-4 max-w-lg mx-auto bg-white p-6 rounded-sm shadow-sm border border-gray-200 mb-8">
  <div class="h-6 bg-gray-300 rounded w-2/3"></div>
  <div class="h-4 bg-gray-300 rounded w-full"></div>
  <div class="h-4 bg-gray-300 rounded w-5/6"></div>
  <div class="h-4 bg-gray-300 rounded w-full"></div>
  <div class="h-4 bg-gray-300 rounded w-1/2"></div>
</div>

<!-- =========  MAIN CONTENT  ========= -->
<section class="bg-white py-8">
  <div id="content-wrapper" class="hidden">
    <div class="flex justify-center">
      <div class="bg-white p-8 rounded-sm shadow-sm border border-gray-200 w-full max-w-lg">
        <h1 class="text-2xl font-semibold text-center text-primary mb-6">
          Prepare Meeting for <span id="course-title" class="text-2xl font-semibold text-center text-primary"></span>
        </h1>
        
        <!-- =========  PREPARE FORM  ========= -->
        <form id="prepare-form" class="space-y-6">
          <div>
            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
            <input type="date" id="date" required 
                   class="w-full p-3 border border-gray-300 rounded-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div>
            <label for="time" class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
            <input type="time" id="time" required 
                   class="w-full p-3 border border-gray-300 rounded-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div id="geo-section" class="hidden">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Meeting Location (click to select)
                <span class="relative group inline-block cursor-pointer text-gray-500 ml-1">
                  ⓘ
                  <div class="absolute z-10 w-64 p-2 text-xs text-white bg-black rounded shadow-lg opacity-0 group-hover:opacity-65 transition-opacity duration-200 bottom-full left-1/2 -translate-x-1/2 mb-2">
                    Click on the map to drop a pin at your meeting location. This will be used to confirm attendance. Map will default to your last meeting location.
                  </div>
                </span>
              </label>
              <div id="map" class="h-64 w-full rounded-sm border border-gray-300 mb-2"></div>
              <p class="text-xs text-gray-400 text-center mt-1">Map data © <a href="https://www.openstreetmap.org/" class="underline hover:text-primary" target="_blank">OpenStreetMap contributors</a></p>
              <input type="hidden" id="latitude">
              <input type="hidden" id="longitude">
              <p class="text-sm text-gray-600" id="location-display"></p>
            </div>

            <div class="flex items-center space-x-2 mt-3">
              <input type="checkbox" id="remote-toggle" 
                     class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary">
              <label for="remote-toggle" class="text-sm text-gray-700">
                This is a remote or hybrid meeting (do not use location to verify attendance)
              </label>
            </div>
          </div>
          
          <div>
            <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">Duration from start (minutes)</label>
            <input type="number" id="duration" required value="10" min="2" max="120"
                   class="w-full p-3 border border-gray-300 rounded-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div class="border-t border-gray-200 pt-6">
            <div class="flex items-center space-x-2 mb-3">
              <input type="checkbox" id="enable-repeat" 
                     class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-primary">
              <label for="enable-repeat" class="text-sm text-gray-700 font-medium">Recurring meeting?</label>
            </div>
          
            <div id="repeat-options" class="space-y-3 pl-4 border-l-2 border-gray-300 hidden">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-700">Every</span>
                <input type="number" id="repeat-interval" value="1" min="1" 
                       class="w-16 p-2 border border-gray-300 rounded-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                <span class="text-sm text-gray-700">week(s)</span>
              </div>
          
              <div>
                <span class="block text-sm text-gray-600 mb-2">Repeat on:</span>
                <div id="repeat-days" class="flex gap-1 flex-wrap">
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="0">S</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="1">M</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="2">T</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="3">W</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="4">T</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="5">F</button>
                  <button type="button" class="day-btn border border-gray-300 rounded-sm px-3 py-2 text-sm hover:bg-gray-50 transition-colors" data-day="6">S</button>
                </div>
              </div>
          
              <div>
                <label for="repeat-end" class="block text-sm text-gray-700 mb-2">Ends on</label>
                <input type="date" id="repeat-end" 
                       class="w-full p-3 border border-gray-300 rounded-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
            </div>
          </div>      

          <button type="submit" 
                  class="w-full py-3 px-4 bg-primary text-white rounded-sm hover:bg-blue-800 transition-colors font-medium">
            Create Meeting
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER (async load) -->
<div id="footer-placeholder"></div>
<script>
  fetch('/partials/footer.html').then(r=>r.text()).then(h=>{document.getElementById('footer-placeholder').innerHTML=h});
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { checkCourseAccess } from '/js/billingGate.js';

  const supabase = createClient(
    'https://hmnpqnzmtanepowfoodn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtbnBxbnptdGFuZXBvd2Zvb2RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NTExNTUsImV4cCI6MjA2MTUyNzE1NX0.2J6U3Cfuif2im5lZqdDdFTcCS2Zpf6YRWDkxnCaQzTI'
  );

  import { requireAuth } from '/js/authUtils.js';
  import notifications from '/js/notifications.js';
  const user = await requireAuth(supabase);

  const GEO_FEATURES_ENABLED = false;

  const form = document.getElementById('prepare-form');
  const params = new URLSearchParams(window.location.search);
  const courseId = params.get('course_id');
  if (!courseId) {
    notifications.error("Missing course_id in URL", 5000);
    setTimeout(() => window.location.href = '/admin.html', 2000);
  }
  
  const userId = user.id;

  if (!await checkCourseAccess(supabase, userId, courseId)) {
    notifications.warning("This course is not covered under your current plan.", 5000);
    setTimeout(() => window.location.href = "/profile.html", 2000);
  }

  const { data: course, error: courseError } = await supabase
    .from('courses')
    .select('title, professor_id')
    .eq('id', courseId)
    .single();

  if (courseError || !course) {
    notifications.error("Unable to load course", 5000);
    setTimeout(() => window.location.href = '/admin.html', 2000);
  }

  if (course.professor_id !== userId) {
    notifications.error("You do not have permission to manage this course.", 5000);
    setTimeout(() => window.location.href = '/admin.html', 2000);
  }

  document.getElementById('course-title').textContent = course.title;
  const now = new Date();
  document.getElementById('date').value = now.toISOString().slice(0, 10); 
  document.getElementById('time').value = now.toTimeString().slice(0, 5); 

  const selectedDays = new Set();
  document.querySelectorAll(".day-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const day = parseInt(btn.dataset.day);
      if (selectedDays.has(day)) {
        selectedDays.delete(day);
        btn.classList.remove("bg-primary", "text-white");
      } else {
        selectedDays.add(day);
        btn.classList.add("bg-primary", "text-white");
      }
    });
  });

  document.getElementById('enable-repeat').addEventListener('change', function () {
    const options = document.getElementById('repeat-options');
    options.classList.toggle('hidden', !this.checked);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";

    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const duration = parseInt(document.getElementById('duration').value, 10);
    if (!courseId || !date || !time || !duration) return;

    const startDateTime = new Date(`${date}T${time}`);
    const expiresAt = new Date(startDateTime.getTime() + duration * 60000).toISOString();

    const latitude = parseFloat(document.getElementById('latitude').value);
    const longitude = parseFloat(document.getElementById('longitude').value);
    const token = crypto.randomUUID();

    const isRemote = document.getElementById('remote-toggle').checked;

    if (GEO_FEATURES_ENABLED) {
      if (!isRemote && (isNaN(latitude) || isNaN(longitude))) {
        notifications.warning("Please select a location on the map or mark as remote.", 5000);
        submitBtn.disabled = false;
        submitBtn.textContent = "Create Meeting";
        return;
      }
    }

    const enableRepeat = document.getElementById('enable-repeat').checked;
    let meetingsToInsert = [];

    if (enableRepeat) {
      const repeatInterval = parseInt(document.getElementById('repeat-interval').value);
      const repeatEnd = new Date(document.getElementById('repeat-end').value);

      for (let d = new Date(startDateTime); d <= repeatEnd; d.setDate(d.getDate() + 1)) {
        const dayOfWeek = d.getDay();
        if (!selectedDays.has(dayOfWeek)) continue;

        const diffInDays = Math.floor((d - startDateTime) / (1000 * 60 * 60 * 24));
        const weeksSinceStart = Math.floor(diffInDays / 7);

        if (weeksSinceStart % repeatInterval !== 0) continue;

        meetingsToInsert.push({
          access_token: crypto.randomUUID(),
          course_id: courseId,
          meeting_date: d.toISOString().slice(0, 10),
          start_time: time,
          expires_at: new Date(d.getTime() + duration * 60000).toISOString(),
          latitude: latitude,
          longitude: longitude,
          remote: isRemote
        });
      }
    } else {
      meetingsToInsert = [{
        access_token: token,
        course_id: courseId,
        meeting_date: date,
        start_time: time,
        expires_at: expiresAt,
        latitude: latitude,
        longitude: longitude,
        remote: isRemote
      }];
    }

    const { error } = await supabase.from('meetings').insert(meetingsToInsert);
    if (error) {
      notifications.error("Error creating meetings: " + error.message, 5000);
      submitBtn.disabled = false;
      submitBtn.textContent = "Create Meeting";
      // Track meeting creation error
      if (window.posthog) {
        posthog.capture('meeting_creation_error', { 
          error: error.message,
          course_id: courseId,
          meeting_count: meetingsToInsert.length
        });
      }
      return;
    }

    notifications.success("Meetings created successfully!", 3000);
    // Track successful meeting creation
    if (window.posthog) {
      posthog.capture('meeting_created', { 
        course_id: courseId,
        meeting_count: meetingsToInsert.length,
        is_recurring: enableRepeat,
        duration: duration
      });
    }
    setTimeout(() => window.location.href = '/admin.html', 2000);
  });

  if (GEO_FEATURES_ENABLED) {
    const map = L.map('map').setView([42.4, 76.5], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);
    map.attributionControl.remove();

    let marker = null;
    map.on('click', function (e) {
      const { lat, lng } = e.latlng;
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;
      document.getElementById('location-display').textContent = `Selected location: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map);
    });

    async function setInitialMapLocation() {
      const { data: lastMeeting } = await supabase
        .from('meetings')
        .select('latitude, longitude')
        .eq('course_id', courseId)
        .not('latitude', 'is', null)
        .not('longitude', 'is', null)
        .order('meeting_date', { ascending: false })
        .order('start_time', { ascending: false })
        .limit(1)
        .single();

      if (lastMeeting && lastMeeting.latitude && lastMeeting.longitude) {
        const { latitude, longitude } = lastMeeting;
        map.setView([latitude, longitude], 14);
        document.getElementById('latitude').value = latitude;
        document.getElementById('longitude').value = longitude;
        document.getElementById('location-display').textContent = `Selected location: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        marker = L.marker([latitude, longitude]).addTo(map);
      } else {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            map.setView([latitude, longitude], 14);
          },
          () => {
            map.setView([42.4, 76.5], 13);
          }
        );
      }
    }
  }

  function showContent() {
    const shimmer = document.getElementById('shimmer');
    const content = document.getElementById('content-wrapper');
    if (shimmer) shimmer.remove();
    if (content) content.classList.remove('hidden');
  }

  //await setInitialMapLocation();
  //map.invalidateSize();
  showContent();

  // Header scroll effect - subtle fade with academic style
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    const scrollY = window.scrollY;
    
    if (scrollY > 20) {
      // Calculate opacity based on scroll position
      // Start at 100% opacity, fade to 70% by 200px scroll
      const maxScroll = 200;
      const minOpacity = 0.7;
      const opacity = Math.max(minOpacity, 1 - (scrollY - 20) / maxScroll * (1 - minOpacity));
      
      header.classList.add('shadow-sm');
      header.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
      header.style.backdropFilter = 'blur(8px)';
      header.classList.remove('border-gray-200');
      header.classList.add('border-gray-100');
    } else {
      // Return to normal state
      header.classList.remove('shadow-sm');
      header.style.backgroundColor = 'rgb(255, 255, 255)';
      header.style.backdropFilter = 'none';
      header.classList.remove('border-gray-100');
      header.classList.add('border-gray-200');
    }
  });
</script>

</body>
</html>
